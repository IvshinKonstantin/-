using System;
using System.Collections.Generic;
using System.Linq;
using System.IO;
using OfficeOpenXml;

namespace AutoParkSystem
{
    // Класс для автомобиля
    public class Car
    {
        public int CarId { get; set; }
        public string Brand { get; set; }
        public string Model { get; set; }
        public int Year { get; set; }

        public Car(int carId, string brand, string model, int year)
        {
            CarId = carId;
            Brand = brand;
            Model = model;
            Year = year;
        }

        public override string ToString()
        {
            return $"ID: {CarId}, Марка: {Brand}, Модель: {Model}, Год выпуска: {Year}";
        }
    }

    // Класс для водителя
    public class Driver
    {
        public int DriverId { get; set; }
        public string Name { get; set; }
        public int Age { get; set; }
        public int Experience { get; set; }

        public Driver(int driverId, string name, int age, int experience)
        {
            DriverId = driverId;
            Name = name;
            Age = age;
            Experience = experience;
        }

        public override string ToString()
        {
            return $"ID: {DriverId}, Имя: {Name}, Возраст: {Age}, Стаж: {Experience} лет";
        }
    }

    // Класс для рейса
    public class Trip
    {
        public int TripId { get; set; }
        public int CarId { get; set; }
        public int DriverId { get; set; }
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }

        public Trip(int tripId, int carId, int driverId, DateTime startDate, DateTime endDate)
        {
            TripId = tripId;
            CarId = carId;
            DriverId = driverId;
            StartDate = startDate;
            EndDate = endDate;
        }

        public override string ToString()
        {
            return $"ID рейса: {TripId}, ID авто: {CarId}, ID водителя: {DriverId}, " +
                   $"Начало: {StartDate:dd.MM.yyyy HH:mm}, Конец: {EndDate:dd.MM.yyyy HH:mm}";
        }
    }

    // Вспомогательный класс для работы с базой данных
    public class DatabaseManager
    {
        private List<Car> cars;
        private List<Driver> drivers;
        private List<Trip> trips;
        private string filePath;

        public DatabaseManager(string filePath)
        {
            this.filePath = filePath;
            cars = new List<Car>();
            drivers = new List<Driver>();
            trips = new List<Trip>();
        }

        // Чтение данных из Excel файла
        public void LoadData()
        {
            try
            {
                ExcelPackage.LicenseContext = LicenseContext.NonCommercial;
                
                using (var package = new ExcelPackage(new FileInfo(filePath)))
                {
                    // Чтение таблицы Автомобили
                    var carsSheet = package.Workbook.Worksheets["Автомобили"];
                    if (carsSheet != null)
                    {
                        int rowCount = carsSheet.Dimension?.Rows ?? 0;
                        for (int row = 2; row <= rowCount; row++)
                        {
                            if (carsSheet.Cells[row, 1].Value != null)
                            {
                                var car = new Car(
                                    Convert.ToInt32(carsSheet.Cells[row, 1].Value),
                                    carsSheet.Cells[row, 2].Value?.ToString() ?? "",
                                    carsSheet.Cells[row, 3].Value?.ToString() ?? "",
                                    Convert.ToInt32(carsSheet.Cells[row, 4].Value)
                                );
                                cars.Add(car);
                            }
                        }
                    }

                    // Чтение таблицы Водители
                    var driversSheet = package.Workbook.Worksheets["Водители"];
                    if (driversSheet != null)
                    {
                        int rowCount = driversSheet.Dimension?.Rows ?? 0;
                        for (int row = 2; row <= rowCount; row++)
                        {
                            if (driversSheet.Cells[row, 1].Value != null)
                            {
                                var driver = new Driver(
                                    Convert.ToInt32(driversSheet.Cells[row, 1].Value),
                                    driversSheet.Cells[row, 2].Value?.ToString() ?? "",
                                    Convert.ToInt32(driversSheet.Cells[row, 3].Value),
                                    Convert.ToInt32(driversSheet.Cells[row, 4].Value)
                                );
                                drivers.Add(driver);
                            }
                        }
                    }

                    // Генерация тестовых данных для рейсов
                    GenerateSampleTrips();
                    
                    Console.WriteLine("Данные успешно загружены!");
                    Console.WriteLine($"Автомобилей: {cars.Count}");
                    Console.WriteLine($"Водителей: {drivers.Count}");
                    Console.WriteLine($"Рейсов: {trips.Count}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Ошибка при загрузке данных: {ex.Message}");
            }
        }

        // Генерация тестовых данных для рейсов
        private void GenerateSampleTrips()
        {
            var random = new Random();
            var tripId = 1;
            
            // Создаем 200 тестовых рейсов
            for (int i = 0; i < 200; i++)
            {
                if (cars.Count > 0 && drivers.Count > 0)
                {
                    var car = cars[random.Next(cars.Count)];
                    var driver = drivers[random.Next(drivers.Count)];
                    
                    var startDate = new DateTime(2020 + random.Next(4), random.Next(1, 13), random.Next(1, 28),
                                               random.Next(24), random.Next(60), 0);
                    var endDate = startDate.AddHours(random.Next(1, 24));
                    
                    trips.Add(new Trip(tripId++, car.CarId, driver.DriverId, startDate, endDate));
                }
            }
        }

        // Просмотр всех автомобилей
        public void ViewCars()
        {
            Console.WriteLine("\n=== СПИСОК АВТОМОБИЛЕЙ ===");
            Console.WriteLine($"Всего автомобилей: {cars.Count}");
            
            Console.WriteLine("\nПоказать все или постранично?");
            Console.WriteLine("1. Показать все");
            Console.WriteLine("2. Постранично (по 20 записей)");
            Console.Write("Выберите: ");
            
            var choice = Console.ReadLine();
            
            if (choice == "1")
            {
                foreach (var car in cars)
                {
                    Console.WriteLine(car);
                }
            }
            else if (choice == "2")
            {
                int pageSize = 20;
                int pageCount = (int)Math.Ceiling((double)cars.Count / pageSize);
                int currentPage = 0;
                
                while (currentPage < pageCount)
                {
                    Console.WriteLine($"\n=== Страница {currentPage + 1} из {pageCount} ===");
                    var pageCars = cars.Skip(currentPage * pageSize).Take(pageSize);
                    
                    foreach (var car in pageCars)
                    {
                        Console.WriteLine(car);
                    }
                    
                    currentPage++;
                    if (currentPage < pageCount)
                    {
                        Console.Write("\nНажмите Enter для следующей страницы или 'q' для выхода: ");
                        if (Console.ReadLine()?.ToLower() == "q")
                            break;
                    }
                }
            }
        }

        // Просмотр всех водителей
        public void ViewDrivers()
        {
            Console.WriteLine("\n=== СПИСОК ВОДИТЕЛЕЙ ===");
            Console.WriteLine($"Всего водителей: {drivers.Count}");
            
            foreach (var driver in drivers)
            {
                Console.WriteLine(driver);
            }
        }

        // Просмотр всех рейсов
        public void ViewTrips()
        {
            Console.WriteLine("\n=== СПИСОК РЕЙСОВ ===");
            Console.WriteLine($"Всего рейсов: {trips.Count}");
            
            Console.WriteLine("\nПоказать все или постранично?");
            Console.WriteLine("1. Показать все");
            Console.WriteLine("2. Постранично (по 20 записей)");
            Console.Write("Выберите: ");
            
            var choice = Console.ReadLine();
            
            if (choice == "1")
            {
                foreach (var trip in trips)
                {
                    Console.WriteLine(trip);
                }
            }
            else if (choice == "2")
            {
                int pageSize = 20;
                int pageCount = (int)Math.Ceiling((double)trips.Count / pageSize);
                int currentPage = 0;
                
                while (currentPage < pageCount)
                {
                    Console.WriteLine($"\n=== Страница {currentPage + 1} из {pageCount} ===");
                    var pageTrips = trips.Skip(currentPage * pageSize).Take(pageSize);
                    
                    foreach (var trip in pageTrips)
                    {
                        Console.WriteLine(trip);
                    }
                    
                    currentPage++;
                    if (currentPage < pageCount)
                    {
                        Console.Write("\nНажмите Enter для следующей страницы или 'q' для выхода: ");
                        if (Console.ReadLine()?.ToLower() == "q")
                            break;
                    }
                }
            }
        }

        // Удаление автомобиля по ID
        public void DeleteCar(int carId)
        {
            var car = cars.FirstOrDefault(c => c.CarId == carId);
            if (car != null)
            {
                cars.Remove(car);
                // Также удаляем связанные рейсы
                trips.RemoveAll(t => t.CarId == carId);
                Console.WriteLine($"Автомобиль с ID {carId} удален.");
            }
            else
            {
                Console.WriteLine($"Автомобиль с ID {carId} не найден.");
            }
        }

        // Удаление водителя по ID
        public void DeleteDriver(int driverId)
        {
            var driver = drivers.FirstOrDefault(d => d.DriverId == driverId);
            if (driver != null)
            {
                drivers.Remove(driver);
                // Также удаляем связанные рейсы
                trips.RemoveAll(t => t.DriverId == driverId);
                Console.WriteLine($"Водитель с ID {driverId} удален.");
            }
            else
            {
                Console.WriteLine($"Водитель с ID {driverId} не найден.");
            }
        }

        // Добавление нового автомобиля
        public void AddCar()
        {
            try
            {
                Console.Write("Введите ID автомобиля: ");
                int id = int.Parse(Console.ReadLine());
                
                if (cars.Any(c => c.CarId == id))
                {
                    Console.WriteLine($"Автомобиль с ID {id} уже существует.");
                    return;
                }
                
                Console.Write("Введите марку: ");
                string brand = Console.ReadLine();
                
                Console.Write("Введите модель: ");
                string model = Console.ReadLine();
                
                Console.Write("Введите год выпуска: ");
                int year = int.Parse(Console.ReadLine());
                
                if (year < 1900 || year > DateTime.Now.Year + 1)
                {
                    Console.WriteLine("Некорректный год выпуска.");
                    return;
                }
                
                cars.Add(new Car(id, brand, model, year));
                Console.WriteLine("Автомобиль успешно добавлен.");
            }
            catch (FormatException)
            {
                Console.WriteLine("Ошибка ввода. Проверьте правильность введенных данных.");
            }
        }

        // Добавление нового водителя
        public void AddDriver()
        {
            try
            {
                Console.Write("Введите ID водителя: ");
                int id = int.Parse(Console.ReadLine());
                
                if (drivers.Any(d => d.DriverId == id))
                {
                    Console.WriteLine($"Водитель с ID {id} уже существует.");
                    return;
                }
                
                Console.Write("Введите имя: ");
                string name = Console.ReadLine();
                
                Console.Write("Введите возраст: ");
                int age = int.Parse(Console.ReadLine());
                
                if (age < 18 || age > 100)
                {
                    Console.WriteLine("Некорректный возраст.");
                    return;
                }
                
                Console.Write("Введите стаж вождения: ");
                int experience = int.Parse(Console.ReadLine());
                
                if (experience < 0 || experience > age - 16)
                {
                    Console.WriteLine("Некорректный стаж вождения.");
                    return;
                }
                
                drivers.Add(new Driver(id, name, age, experience));
                Console.WriteLine("Водитель успешно добавлен.");
            }
            catch (FormatException)
            {
                Console.WriteLine("Ошибка ввода. Проверьте правильность введенных данных.");
            }
        }

        // ЗАПРОС 1 (к одной таблице): Получить список автомобилей конкретной марки
        public List<Car> GetCarsByBrand(string brand)
        {
            return cars.Where(c => c.Brand.Equals(brand, StringComparison.OrdinalIgnoreCase)).ToList();
        }

        // ЗАПРОС 2 (к двум таблицам): Получить список водителей с опытом больше указанного
        public List<Driver> GetDriversWithExperienceMoreThan(int experience)
        {
            return drivers.Where(d => d.Experience > experience).ToList();
        }

        // ЗАПРОС 3 (к трем таблицам): Количество рейсов автомобилей определенной марки за год
        public int GetTripsCountByBrandAndYear(string brand, int year)
        {
            return trips.Count(t => 
                t.StartDate.Year == year && 
                cars.Any(c => c.CarId == t.CarId && 
                c.Brand.Equals(brand, StringComparison.OrdinalIgnoreCase)));
        }

        // ЗАПРОС 4 (к трем таблицам): Средний возраст водителей, управлявших автомобилями определенной марки
        public double GetAverageAgeByCarBrand(string brand)
        {
            var driverIds = trips
                .Where(t => cars.Any(c => c.CarId == t.CarId && 
                         c.Brand.Equals(brand, StringComparison.OrdinalIgnoreCase)))
                .Select(t => t.DriverId)
                .Distinct();

            var relevantDrivers = drivers.Where(d => driverIds.Contains(d.DriverId));
            
            return relevantDrivers.Any() ? relevantDrivers.Average(d => d.Age) : 0;
        }

        // Пример запроса из задания
        public int GetTripsByToyotaAfter2005In2023()
        {
            return trips.Count(t => 
                t.StartDate.Year == 2023 && 
                t.EndDate.Year == 2023 &&
                cars.Any(c => c.CarId == t.CarId && 
                         c.Brand.Equals("Toyota", StringComparison.OrdinalIgnoreCase) && 
                         c.Year > 2005));
        }

        // Сохранение данных в Excel
        public void SaveData()
        {
            try
            {
                ExcelPackage.LicenseContext = LicenseContext.NonCommercial;
                
                using (var package = new ExcelPackage())
                {
                    // Сохранение автомобилей
                    var carsSheet = package.Workbook.Worksheets.Add("Автомобили");
                    carsSheet.Cells[1, 1].Value = "ID автомобиля";
                    carsSheet.Cells[1, 2].Value = "Марка";
                    carsSheet.Cells[1, 3].Value = "Модель";
                    carsSheet.Cells[1, 4].Value = "Год выпуска";
                    
                    for (int i = 0; i < cars.Count; i++)
                    {
                        carsSheet.Cells[i + 2, 1].Value = cars[i].CarId;
                        carsSheet.Cells[i + 2, 2].Value = cars[i].Brand;
                        carsSheet.Cells[i + 2, 3].Value = cars[i].Model;
                        carsSheet.Cells[i + 2, 4].Value = cars[i].Year;
                    }

                    // Сохранение водителей
                    var driversSheet = package.Workbook.Worksheets.Add("Водители");
                    driversSheet.Cells[1, 1].Value = "ID водителя";
                    driversSheet.Cells[1, 2].Value = "Имя";
                    driversSheet.Cells[1, 3].Value = "Возраст";
                    driversSheet.Cells[1, 4].Value = "Стаж вождения";
                    
                    for (int i = 0; i < drivers.Count; i++)
                    {
                        driversSheet.Cells[i + 2, 1].Value = drivers[i].DriverId;
                        driversSheet.Cells[i + 2, 2].Value = drivers[i].Name;
                        driversSheet.Cells[i + 2, 3].Value = drivers[i].Age;
                        driversSheet.Cells[i + 2, 4].Value = drivers[i].Experience;
                    }

                    // Сохранение рейсов
                    var tripsSheet = package.Workbook.Worksheets.Add("Рейсы");
                    tripsSheet.Cells[1, 1].Value = "ID рейса";
                    tripsSheet.Cells[1, 2].Value = "ID автомобиля";
                    tripsSheet.Cells[1, 3].Value = "ID водителя";
                    tripsSheet.Cells[1, 4].Value = "Дата начала";
                    tripsSheet.Cells[1, 5].Value = "Дата окончания";
                    
                    for (int i = 0; i < trips.Count; i++)
                    {
                        tripsSheet.Cells[i + 2, 1].Value = trips[i].TripId;
                        tripsSheet.Cells[i + 2, 2].Value = trips[i].CarId;
                        tripsSheet.Cells[i + 2, 3].Value = trips[i].DriverId;
                        tripsSheet.Cells[i + 2, 4].Value = trips[i].StartDate;
                        tripsSheet.Cells[i + 2, 5].Value = trips[i].EndDate;
                    }

                    package.SaveAs(new FileInfo(filePath));
                    Console.WriteLine("\nДанные успешно сохранены в файл!");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Ошибка при сохранении данных: {ex.Message}");
            }
        }
    }

    // Основной класс программы
    class Program
    {
        static void Main(string[] args)
        {
            Console.OutputEncoding = System.Text.Encoding.UTF8;
            Console.Title = "Система управления автопарком";
            
            var dbManager = new DatabaseManager("LR5-var4.xls");
            
            try
            {
                Console.WriteLine("=== СИСТЕМА УПРАВЛЕНИЯ АВТОПАРКОМ ===");
                Console.WriteLine("Загрузка данных...");
                dbManager.LoadData();
                
                bool exit = false;
                while (!exit)
                {
                    DisplayMenu();
                    
                    var choice = Console.ReadLine();
                    
                    switch (choice)
                    {
                        case "1":
                            Console.Clear();
                            dbManager.ViewCars();
                            WaitForContinue();
                            break;
                            
                        case "2":
                            Console.Clear();
                            dbManager.ViewDrivers();
                            WaitForContinue();
                            break;
                            
                        case "3":
                            Console.Clear();
                            dbManager.ViewTrips();
                            WaitForContinue();
                            break;
                            
                        case "4":
                            Console.Clear();
                            DeleteItem(dbManager);
                            WaitForContinue();
                            break;
                            
                        case "5":
                            Console.Clear();
                            AddItem(dbManager);
                            WaitForContinue();
                            break;
                            
                        case "6":
                            Console.Clear();
                            ExecuteQueries(dbManager);
                            WaitForContinue();
                            break;
                            
                        case "7":
                            Console.Clear();
                            dbManager.SaveData();
                            WaitForContinue();
                            break;
                            
                        case "8":
                            Console.Clear();
                            Console.WriteLine("Вы уверены, что хотите выйти? Все несохраненные изменения будут потеряны.");
                            Console.WriteLine("1. Да, выйти");
                            Console.WriteLine("2. Нет, остаться");
                            Console.Write("Выберите: ");
                            
                            if (Console.ReadLine() == "1")
                            {
                                exit = true;
                                Console.WriteLine("Выход из программы...");
                            }
                            break;
                            
                        default:
                            Console.Clear();
                            Console.WriteLine("Неверный выбор. Попробуйте снова.");
                            WaitForContinue();
                            break;
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Критическая ошибка: {ex.Message}");
                Console.WriteLine("Нажмите любую клавишу для выхода...");
                Console.ReadKey();
            }
        }

        static void DisplayMenu()
        {
            Console.Clear();
            Console.WriteLine("=== ГЛАВНОЕ МЕНЮ ===");
            Console.WriteLine("1. Просмотреть автомобили");
            Console.WriteLine("2. Просмотреть водителей");
            Console.WriteLine("3. Просмотреть рейсы");
            Console.WriteLine("4. Удалить элемент");
            Console.WriteLine("5. Добавить элемент");
            Console.WriteLine("6. Выполнить запросы");
            Console.WriteLine("7. Сохранить изменения");
            Console.WriteLine("8. Выход");
            Console.Write("\nВыберите действие (1-8): ");
        }

        static void WaitForContinue()
        {
            Console.WriteLine("\nНажмите любую клавишу для возврата в меню...");
            Console.ReadKey();
        }

        static void DeleteItem(DatabaseManager dbManager)
        {
            Console.WriteLine("=== УДАЛЕНИЕ ЭЛЕМЕНТОВ ===");
            Console.WriteLine("1. Удалить автомобиль");
            Console.WriteLine("2. Удалить водителя");
            Console.Write("Выберите тип элемента: ");
            
            var choice = Console.ReadLine();
            
            Console.Write("Введите ID для удаления: ");
            if (int.TryParse(Console.ReadLine(), out int id))
            {
                if (choice == "1")
                {
                    dbManager.DeleteCar(id);
                }
                else if (choice == "2")
                {
                    dbManager.DeleteDriver(id);
                }
                else
                {
                    Console.WriteLine("Неверный выбор.");
                }
            }
            else
            {
                Console.WriteLine("Неверный формат ID.");
            }
        }

        static void AddItem(DatabaseManager dbManager)
        {
            Console.WriteLine("=== ДОБАВЛЕНИЕ ЭЛЕМЕНТОВ ===");
            Console.WriteLine("1. Добавить автомобиль");
            Console.WriteLine("2. Добавить водителя");
            Console.Write("Выберите тип элемента: ");
            
            var choice = Console.ReadLine();
            
            if (choice == "1")
            {
                dbManager.AddCar();
            }
            else if (choice == "2")
            {
                dbManager.AddDriver();
            }
            else
            {
                Console.WriteLine("Неверный выбор.");
            }
        }

        static void ExecuteQueries(DatabaseManager dbManager)
        {
            Console.WriteLine("=== ВЫПОЛНЕНИЕ ЗАПРОСОВ ===");
            Console.WriteLine("1. Список автомобилей определенной марки");
            Console.WriteLine("2. Водители с опытом больше 5 лет");
            Console.WriteLine("3. Количество рейсов марки за год");
            Console.WriteLine("4. Средний возраст водителей марки");
            Console.WriteLine("5. Пример из задания (Toyota после 2005 в 2023)");
            Console.Write("Выберите запрос (1-5): ");
            
            var choice = Console.ReadLine();
            
            switch (choice)
            {
                case "1":
                    Console.Write("Введите марку автомобиля: ");
                    string brand1 = Console.ReadLine();
                    var cars = dbManager.GetCarsByBrand(brand1);
                    Console.WriteLine($"\nАвтомобили марки '{brand1}' ({cars.Count} шт.):");
                    if (cars.Any())
                    {
                        foreach (var car in cars)
                        {
                            Console.WriteLine(car);
                        }
                    }
                    else
                    {
                        Console.WriteLine("Автомобилей не найдено.");
                    }
                    break;
                    
                case "2":
                    var expDrivers = dbManager.GetDriversWithExperienceMoreThan(5);
                    Console.WriteLine($"\nВодители со стажем более 5 лет ({expDrivers.Count} чел.):");
                    if (expDrivers.Any())
                    {
                        foreach (var driver in expDrivers)
                        {
                            Console.WriteLine(driver);
                        }
                    }
                    else
                    {
                        Console.WriteLine("Водителей не найдено.");
                    }
                    break;
                    
                case "3":
                    Console.Write("Введите марку автомобиля: ");
                    string brand3 = Console.ReadLine();
                    Console.Write("Введите год: ");
                    if (int.TryParse(Console.ReadLine(), out int year3))
                    {
                        int tripsCount = dbManager.GetTripsCountByBrandAndYear(brand3, year3);
                        Console.WriteLine($"\nКоличество рейсов {brand3} в {year3} году: {tripsCount}");
                    }
                    else
                    {
                        Console.WriteLine("Неверный формат года.");
                    }
                    break;
                    
                case "4":
                    Console.Write("Введите марку автомобиля: ");
                    string brand4 = Console.ReadLine();
                    double avgAge = dbManager.GetAverageAgeByCarBrand(brand4);
                    Console.WriteLine($"\nСредний возраст водителей {brand4}: {avgAge:F1} лет");
                    break;
                    
                case "5":
                    int toyotaTrips = dbManager.GetTripsByToyotaAfter2005In2023();
                    Console.WriteLine($"\nКоличество рейсов Toyota (выпуск после 2005 года) в 2023 году: {toyotaTrips}");
                    Console.WriteLine("(Рейсы считаются только те, которые начались и закончились в 2023 году)");
                    break;
                    
                default:
                    Console.WriteLine("Неверный выбор.");
                    break;
            }
        }
    }
}
